# MacroShockwave 下注与结算规则详细说明

## 文档版本
- **版本**：V1.0
- **最后更新**：2026-01-17
- **适用范围**：所有 Shockwave 下注玩法

---

## 目录
1. [奖金池机制](#1-奖金池机制)
2. [手续费规则](#2-手续费规则)
3. [下注规则](#3-下注规则)
4. [结算规则](#4-结算规则)
5. [特殊情况处理](#5-特殊情况处理)
6. [玩法详细规则](#6-玩法详细规则)
7. [资金安全与合约](#7-资金安全与合约)

---

## 1. 奖金池机制

### 1.1 奖金池构成

每个事件的每个玩法都有**独立的奖金池**：

```
事件：CPI 2026-02-14
├─ 玩法 A (数据狙击手) 奖金池
│  ├─ 鸽派选项池
│  ├─ 中性选项池
│  └─ 鹰派选项池
│
├─ 玩法 B (波动猎人) 奖金池
│  ├─ 风平浪静选项池
│  └─ 惊涛骇浪选项池
│
└─ 玩法 C (精准点位) 奖金池
   ├─ 区间 1 选项池
   ├─ 区间 2 选项池
   ├─ ...
   └─ 区间 7 选项池
```

### 1.2 奖金池计算公式

```javascript
// 每个玩法的总奖金池
总奖金池 = Σ(所有选项的下注总额) × (1 - 平台手续费率)

// 平台手续费率
平台手续费率 = 3%

// 示例计算
假设某事件「数据狙击手」玩法：
- 鸽派下注总额：10,000 USDT
- 中性下注总额：5,000 USDT
- 鹰派下注总额：15,000 USDT

总下注额 = 10,000 + 5,000 + 15,000 = 30,000 USDT
平台手续费 = 30,000 × 3% = 900 USDT
总奖金池 = 30,000 - 900 = 29,100 USDT
```

### 1.3 奖金池分配

**核心原则**：赢家瓜分奖金池

```javascript
// 单个获胜用户的奖金计算
用户获得奖金 = (用户下注额 / 获胜选项总下注额) × 总奖金池

// 示例：
假设「鹰派」是正确结果，鹰派下注总额 15,000 USDT
用户 A 在鹰派下注了 1,500 USDT

用户 A 获得奖金 = (1,500 / 15,000) × 29,100 = 2,910 USDT
用户 A 收益 = 2,910 - 1,500 = 1,410 USDT
用户 A 收益率 = 1,410 / 1,500 = 94%
```

### 1.4 实时赔率显示

**赔率定义**：用户投入 1 USDT 可以获得的总回报（含本金）

```javascript
// 某选项的实时赔率计算
选项赔率 = 总奖金池 / 该选项当前下注总额

// 注意：赔率会随着下注动态变化
// 用户下注时看到的是「预估赔率」，实际赔率以下注截止时为准

// 示例：
总奖金池 = 29,100 USDT（已扣除手续费）
鸽派下注额 = 10,000 USDT

鸽派赔率 = 29,100 / 10,000 = 2.91x

// 如果此时又有用户在鸽派下注 2,000 USDT：
新的鸽派下注额 = 10,000 + 2,000 = 12,000 USDT
新的总奖金池 = (30,000 + 2,000) × 0.97 = 31,040 USDT
新的鸽派赔率 = 31,040 / 12,000 = 2.59x ← 赔率下降
```

**前端显示**：
```
┌─────────────────────────────────────┐
│ 🕊️ 鸽派 (Dovish)                    │
│ 公布值 < 预期值                      │
│                                     │
│ 当前赔率: 2.91x  ⚠️ 实时变动        │
│ 下注占比: 33.3%                     │
│ [ ━━━━━━━                    ]      │
│                                     │
│ 💡 您下注后的预估赔率: ~2.85x       │
│    (基于您的下注额计算)              │
└─────────────────────────────────────┘
```

---

## 2. 手续费规则

### 2.1 手续费费率

```
平台手续费 = 3%（从总下注额中扣除）
Gas 费 = 用户自行承担（根据链上实际消耗）
```

### 2.2 手续费收取时机

```
下注时：
- 用户支付：下注金额 + Gas 费
- 进入奖金池：下注金额（先进池，结算时统一扣手续费）
- 平台收取：结算时从奖金池扣除 3%

示例：
用户下注 100 USDT
├─ 100 USDT → 进入奖金池
├─ ~0.5 USDT → Gas 费（用户钱包支付）
└─ 结算时，从奖金池总额扣除 3% 给平台
```

### 2.3 手续费用途

```
平台手续费 3% 分配：
├─ 1.5% → 运营成本（服务器、数据源、开发维护）
├─ 1.0% → 保险基金（应对极端情况）
└─ 0.5% → 未来治理基金（DAO 预留）
```

### 2.4 手续费透明度

- 每个事件页面显示总手续费收取
- 用户订单详情显示手续费占比
- 平台定期公开手续费使用报告

```
┌─────────────────────────────────────┐
│ 📊 本次下注详情                      │
│                                     │
│ 下注金额：100.00 USDT               │
│ 预估赔率：2.85x                     │
│ 预估总回报：285.00 USDT             │
│ 预估净收益：185.00 USDT             │
│                                     │
│ 📝 费用说明：                        │
│ • 平台手续费已计入赔率 (3%)         │
│ • Gas 费约：0.5 USDT               │
│                                     │
│ [ 确认下注 ]                        │
└─────────────────────────────────────┘
```

---

## 3. 下注规则

### 3.1 下注金额限制

```javascript
// 单笔下注限制
最小下注额 = 10 USDT
最大下注额 = 10,000 USDT (单笔单选项)

// 单用户单事件限制
单用户单事件总下注上限 = 50,000 USDT (所有玩法合计)

// 单事件单玩法总池限制
单事件单玩法奖金池上限 = 1,000,000 USDT (达到后该玩法停止接受下注)
```

**示例限制场景**：
```
用户 A 在 CPI 2026-02-14 事件中：
✅ 可以：
  - 数据狙击手下注 10,000 USDT (鸽派)
  - 波动猎人下注 20,000 USDT (惊涛骇浪)
  - 精准点位下注 15,000 USDT ($48-49K)
  总计：45,000 USDT ✅ 未超过 50,000 限制

❌ 不可以：
  - 再下注 10,000 USDT → 总计 55,000 USDT ❌ 超过限制
```

### 3.2 下注时间窗口

```
事件生命周期：

[待开放]
  ↓ 事件发布前 7 天开放
[下注中] ← 可以下注
  ↓ 数据发布前 5 分钟
[即将锁定] ← 最后 5 分钟，红色警告
  ↓ 数据发布时刻
[已锁定] ← 禁止下注
  ↓ 等待数据公布
[数据发布]
  ↓ 15 分钟延迟（价格稳定）
[结算中]
  ↓ 智能合约计算
[已结算] ← 用户可提取奖金
```

**时间要求**：
```javascript
// 下注截止时间
下注截止 = 数据发布时间 - 5 分钟

// 示例：
CPI 数据发布时间：2026-02-14 21:30:00 UTC
下注截止时间：2026-02-14 21:25:00 UTC

// 链上时间戳验证
if (block.timestamp >= eventReleaseTime - 5 minutes) {
  revert("下注已截止");
}
```

### 3.3 下注确认流程

```
1. 用户选择事件和玩法
   ↓
2. 选择预测选项
   ↓
3. 输入下注金额
   ↓ 前端验证
4. 验证金额限制
   - ✅ ≥ 10 USDT
   - ✅ ≤ 10,000 USDT
   - ✅ 用户总下注未超过 50,000 USDT
   - ✅ 用户余额充足
   ↓
5. 显示预估收益和赔率
   ↓ 用户确认
6. 调用 Luffa 钱包
   ↓
7. 用户签名授权
   ↓
8. 发送链上交易
   ↓
9. 等待交易确认 (约 3-10 秒)
   ↓
10. 下注成功 ✅
    - 更新奖金池
    - 更新用户持仓
    - 更新实时赔率
```

### 3.4 下注修改与取消

**重要规则**：
```
❌ 下注后不可修改
❌ 下注后不可取消
✅ 只能在同一事件下追加新的下注（遵守总额限制）
```

**原因**：
- 保证奖金池公平性
- 防止用户根据赔率变化反悔
- 符合预测市场规则

**用户提示**：
```
┌─────────────────────────────────────┐
│ ⚠️ 重要提示                          │
│                                     │
│ • 下注后不可修改或取消              │
│ • 请仔细确认您的预测和金额          │
│ • 赔率会实时变化，以下注时为准      │
│                                     │
│ [ 我已知晓 ]  [ 确认下注 ]         │
└─────────────────────────────────────┘
```

### 3.5 多次下注规则

**允许场景**：
```
✅ 同一事件，不同玩法下注
✅ 同一玩法，不同选项下注（对冲）
✅ 同一选项，多次追加下注

示例：
用户 A 在 CPI 事件中：
1. 数据狙击手 - 鸽派：5,000 USDT
2. 数据狙击手 - 鹰派：3,000 USDT (对冲)
3. 波动猎人 - 惊涛骇浪：2,000 USDT
4. 数据狙击手 - 鸽派：2,000 USDT (追加)

总计：12,000 USDT ✅
```

**对冲说明**：
```
用户可以在同一玩法的多个选项下注来降低风险

示例：
鸽派下注 5,000 USDT (赔率 2.0x)
鹰派下注 5,000 USDT (赔率 2.0x)

结果 1：鸽派赢 → 获得 10,000 USDT → 盈亏 0
结果 2：鹰派赢 → 获得 10,000 USDT → 盈亏 0
结果 3：中性赢 → 两边都输 → 亏损 10,000 USDT

💡 对冲策略可以降低风险，但也降低收益
```

---

## 4. 结算规则

### 4.1 结算触发条件

```javascript
// 结算必须满足以下所有条件
结算条件 = {
  1. 官方数据已正式发布,
  2. 数据来源已通过 Oracle 验证,
  3. BTC 价格已稳定（15 分钟后）,
  4. 多数据源确认一致
}

// 结算触发流程
数据发布 (T0)
  ↓ 等待 15 分钟
价格采样 (T0 + 15min)
  ↓ Oracle 提交数据
链上验证
  ↓ 3/5 Oracle 节点确认
触发结算
  ↓ 智能合约计算
分配奖金
```

### 4.2 结算计算规则

#### 4.2.1 玩法 A：数据狙击手结算

```javascript
// 步骤 1：获取数据
const 预期值 = event.consensusValue;  // 事件预期值
const 公布值 = oracle.publishedValue;  // 官方公布值
const 容差 = event.tolerance;          // 容差标准

// 步骤 2：判定结果
let 结果;
if (公布值 < 预期值 - 容差) {
  结果 = "鸽派";
} else if (公布值 > 预期值 + 容差) {
  结果 = "鹰派";
} else {
  结果 = "中性";
}

// 步骤 3：计算奖金池
const 总下注额 = 鸽派下注 + 中性下注 + 鹰派下注;
const 总奖金池 = 总下注额 × 0.97;  // 扣除 3% 手续费

// 步骤 4：获胜选项下注额
const 获胜选项下注额 = bets[结果].totalAmount;

// 步骤 5：分配给每个获胜用户
for (const user of 获胜用户列表) {
  const 用户下注额 = user.betAmount;
  const 用户奖金 = (用户下注额 / 获胜选项下注额) × 总奖金池;

  // 转账给用户
  transfer(user.address, 用户奖金);
}
```

**具体示例**：
```
事件：CPI 2026-02-14
预期值：3.2%
容差：0.1%
公布值：3.5%

判定过程：
3.5% > 3.2% + 0.1% = 3.3%
→ 结果 = 鹰派 ✅

奖金池：
- 鸽派下注：10,000 USDT
- 中性下注：5,000 USDT
- 鹰派下注：15,000 USDT
- 总下注：30,000 USDT
- 总奖金池：30,000 × 0.97 = 29,100 USDT

分配：
- 鹰派获胜，鹰派下注总额：15,000 USDT
- 用户 A 鹰派下注：3,000 USDT
  → 用户 A 获得：(3,000 / 15,000) × 29,100 = 5,820 USDT
  → 用户 A 收益：5,820 - 3,000 = 2,820 USDT (94% ROI)

- 用户 B 鹰派下注：1,500 USDT
  → 用户 B 获得：(1,500 / 15,000) × 29,100 = 2,910 USDT
  → 用户 B 收益：2,910 - 1,500 = 1,410 USDT (94% ROI)
```

#### 4.2.2 玩法 B：波动猎人结算

```javascript
// 步骤 1：获取价格数据
const 基准价格 = getPriceAt(数据发布时间 - 1分钟);  // T0 - 1min
const 结算价格 = getPriceAt(数据发布时间 + 15分钟); // T0 + 15min

// 价格数据源（多源取中位数）
const prices = [
  binance.getPrice(),   // Binance BTC/USDT
  coinbase.getPrice(),  // Coinbase BTC/USD
  kraken.getPrice()     // Kraken BTC/USD
];
const price = median(prices);  // 取中位数，防止异常

// 步骤 2：计算波动幅度
const 波动幅度 = Math.abs(结算价格 - 基准价格) / 基准价格 × 100;

// 步骤 3：判定结果
const 波动阈值 = 2.0;  // 2%
let 结果;
if (波动幅度 < 波动阈值) {
  结果 = "风平浪静";
} else {
  结果 = "惊涛骇浪";
}

// 步骤 4：分配奖金（同玩法 A）
const 总奖金池 = (风平浪静下注 + 惊涛骇浪下注) × 0.97;
const 获胜选项下注额 = bets[结果].totalAmount;

for (const user of 获胜用户列表) {
  const 用户奖金 = (user.betAmount / 获胜选项下注额) × 总奖金池;
  transfer(user.address, 用户奖金);
}
```

**具体示例**：
```
事件：NFP 2026-02-07
数据发布时间：2026-02-07 21:30:00 UTC

价格采样：
- 基准价格 (21:29:00)：$48,500
- 结算价格 (21:45:00)：$49,800

多数据源验证：
- Binance: $49,820
- Coinbase: $49,780
- Kraken: $49,800
- 中位数: $49,800 ✅

波动计算：
波动幅度 = |49,800 - 48,500| / 48,500 × 100% = 2.68%

判定：
2.68% ≥ 2.0% → 结果 = 惊涛骇浪 ✅

奖金池：
- 风平浪静下注：8,000 USDT
- 惊涛骇浪下注：20,000 USDT
- 总下注：28,000 USDT
- 总奖金池：28,000 × 0.97 = 27,160 USDT

分配：
- 惊涛骇浪获胜，总下注：20,000 USDT
- 用户 C 下注：5,000 USDT
  → 获得：(5,000 / 20,000) × 27,160 = 6,790 USDT
  → 收益：6,790 - 5,000 = 1,790 USDT (35.8% ROI)
```

#### 4.2.3 玩法 C：精准点位结算

```javascript
// 步骤 1：获取结算价格（同玩法 B）
const 结算价格 = getPriceAt(数据发布时间 + 15分钟);

// 步骤 2：确定价格所在区间
const 价格区间 = [
  { min: 0,      max: 46000,  name: "< $46,000" },
  { min: 46000,  max: 47000,  name: "$46,000-47,000" },
  { min: 47000,  max: 48000,  name: "$47,000-48,000" },
  { min: 48000,  max: 49000,  name: "$48,000-49,000" },
  { min: 49000,  max: 50000,  name: "$49,000-50,000" },
  { min: 50000,  max: 51000,  name: "$50,000-51,000" },
  { min: 51000,  max: 999999, name: "> $51,000" }
];

let 中奖区间;
for (const 区间 of 价格区间) {
  if (结算价格 >= 区间.min && 结算价格 < 区间.max) {
    中奖区间 = 区间;
    break;
  }
}

// 步骤 3：分配奖金
const 总下注额 = Σ(所有区间的下注额);
const 总奖金池 = 总下注额 × 0.97;
const 中奖区间下注额 = bets[中奖区间].totalAmount;

// 如果中奖区间有人下注
if (中奖区间下注额 > 0) {
  for (const user of 中奖用户列表) {
    const 用户奖金 = (user.betAmount / 中奖区间下注额) × 总奖金池;
    transfer(user.address, 用户奖金);
  }
} else {
  // 无人中奖，执行退款流程（见 4.3）
  refundAll();
}
```

**具体示例**：
```
事件：GDP Q4 2025
数据发布时间：2026-01-28 20:00:00 UTC
当前 BTC 价格：$48,523

价格区间设置：
1. < $46,000       → 12 人下注，共 1,200 USDT
2. $46,000-47,000  → 18 人下注，共 2,400 USDT
3. $47,000-48,000  → 35 人下注，共 5,800 USDT
4. $48,000-49,000  → 120 人下注，共 28,000 USDT ⭐ 热门
5. $49,000-50,000  → 42 人下注，共 8,500 USDT
6. $50,000-51,000  → 15 人下注，共 2,100 USDT
7. > $51,000       → 8 人下注，共 1,000 USDT

总下注：49,000 USDT
总奖金池：49,000 × 0.97 = 47,530 USDT

结算价格 (20:15:00)：$49,450

判定：
$49,450 在区间 5 ($49,000-50,000) ✅

分配：
- 区间 5 下注总额：8,500 USDT
- 42 位中奖用户瓜分 47,530 USDT
- 平均赔率：47,530 / 8,500 = 5.59x

用户 D 下注：500 USDT
→ 获得：(500 / 8,500) × 47,530 = 2,796 USDT
→ 收益：2,796 - 500 = 2,296 USDT (459% ROI) 🎉
```

### 4.3 无人中奖退款机制

**触发条件**：
```javascript
// 仅适用于「玩法 C：精准点位」
if (中奖区间下注额 === 0) {
  // 无人预测正确，执行全额退款
  执行退款流程();
}

// 玩法 A 和 B 必然有人中奖（选项少，覆盖全部可能）
```

**退款规则**：
```
无人中奖时：
✅ 所有用户获得 100% 本金退回
✅ 平台不收取手续费
❌ 不支付 Gas 费（用户自行承担原下注 Gas 费）

退款流程：
1. 智能合约检测到无人中奖
   ↓
2. 自动触发退款函数
   ↓
3. 遍历所有用户订单
   ↓
4. 原路退回下注金额
   ↓
5. 更新订单状态为「已退款」
```

**退款示例**：
```
事件：CPI 2026-03-14
玩法：精准点位

区间设置（基于当前价 $52,000）：
1. < $50,000       → 5 人下注，共 500 USDT
2. $50,000-51,000  → 12 人下注，共 2,400 USDT
3. $51,000-52,000  → 45 人下注，共 12,000 USDT
4. $52,000-53,000  → 80 人下注，共 22,000 USDT
5. $53,000-54,000  → 38 人下注，共 9,500 USDT
6. $54,000-55,000  → 18 人下注，共 3,600 USDT
7. > $55,000       → 2 人下注，共 200 USDT

结算价格：$55,800 ← 超出所有区间！

结果：
❌ 无人预测在区间 7 (> $55,000)
（注：区间 7 表示 > $55,000，但实际上限为 $56,000）

处理：
✅ 全部 200 位用户获得 100% 退款
✅ 总退款：50,200 USDT
✅ 平台不收手续费

用户通知：
┌─────────────────────────────────────┐
│ 🔄 订单已退款                        │
│                                     │
│ 事件：CPI 2026-03-14                │
│ 玩法：精准点位                       │
│ 结算价：$55,800                     │
│                                     │
│ 本次无人预测正确                    │
│ 您的下注已全额退回                  │
│                                     │
│ 退款金额：500 USDT ✅               │
│                                     │
└─────────────────────────────────────┘
```

**退款优化**（V1.1 规划）：
```
为避免频繁无人中奖，未来改进：
1. 动态调整价格区间宽度
2. 增加兜底区间（如 "其他价格"）
3. 根据历史波动率智能设置区间
```

### 4.4 结算时间保证

```
结算 SLA (服务等级协议)：

正常情况：
- 数据发布后 20 分钟内完成结算
- 用户可立即提取奖金

异常情况：
- 数据源延迟：最多等待 2 小时
- 多数据源冲突：人工介入审核
- Oracle 故障：启用备用 Oracle

最大延迟：
- 承诺 24 小时内必须结算
- 超过 24 小时，启用紧急多签结算
```

### 4.5 结算争议处理

**争议情况**：
```
可能的争议：
1. 数据源不一致
2. 价格操纵质疑
3. Oracle 数据错误
4. 时间戳争议
```

**处理流程**：
```
1. 用户提交争议 (结算后 24 小时内)
   ↓
2. 平台审核团队调查
   ↓
3. 调取多数据源证据
   ↓
4. 3 个工作日内给出结论
   ↓
5. 如确认错误：重新结算 + 补偿
   ↓
6. 如无误：维持原结果
```

**重新结算机制**：
```javascript
// 仅限发现严重错误时
function emergencyResettle(eventId, correctResult) {
  require(msg.sender == governance, "仅治理多签可执行");
  require(block.timestamp < settlementTime + 7 days, "超过争议期");

  // 撤销原结算
  revertSettlement(eventId);

  // 重新计算和分配
  settleEvent(eventId, correctResult);

  // 补偿受影响用户
  compensateAffectedUsers(eventId);
}
```

---

## 5. 特殊情况处理

### 5.1 数据未发布或延迟

**场景**：官方数据发布时间延迟或取消

```
处理方案 1：延迟发布 (< 24 小时)
→ 等待数据发布，延长结算时间
→ 用户订单保持有效

处理方案 2：长时间延迟 (> 24 小时)
→ 平台发起投票
→ 3/5 多签决定：等待 or 退款

处理方案 3：数据取消发布
→ 全额退款所有用户
→ 不收取手续费
```

### 5.2 极端市场波动

**场景**：BTC 价格极端波动（如 >30% 单日）

```
风控措施：
1. 暂停新事件开放
2. 现有订单正常结算
3. 启动价格异常检测
4. 多数据源交叉验证
5. 必要时人工审核

示例：
如果 15 分钟内 BTC 价格波动 > 10%
→ 自动触发审核
→ 延长结算时间至价格稳定
→ 防止价格操纵影响结果
```

### 5.3 智能合约暂停

**场景**：发现合约漏洞或遭受攻击

```
紧急暂停流程：
1. 多签管理员触发 pause()
   ↓
2. 立即停止所有下注
   ↓
3. 现有订单冻结
   ↓
4. 调查和修复
   ↓
5. 审计通过后恢复
   ↓
6. 用户可选择：
   - 继续持有订单
   - 申请退款（无手续费）
```

### 5.4 Oracle 故障

**场景**：价格 Oracle 或数据 Oracle 无法提供数据

```
备用方案：
1. 主 Oracle：Chainlink
2. 备用 1：Band Protocol
3. 备用 2：API3
4. 最后：人工多签提交

要求：
- 至少 3/5 Oracle 节点确认
- 数据一致性验证
- 时间戳在允许范围内
```

### 5.5 用户作弊检测

**可能的作弊行为**：
```
1. 多账户刷量
2. 下注后取消（通过 MEV）
3. 内幕信息交易
4. 机器人操纵
```

**检测与处理**：
```javascript
// 异常检测规则
function detectAnomalies(user, bet) {
  // 规则 1：单用户多账户
  if (sameIPMultipleAccounts(user)) {
    flagForReview(user);
  }

  // 规则 2：大额异常下注
  if (bet.amount > 10000 && isNewUser(user)) {
    requireKYC(user);
  }

  // 规则 3：赔率操纵
  if (bet.amount > poolSize * 0.5) {
    limitOrder(bet, poolSize * 0.3);  // 限制单笔最大影响
  }
}

// 处理措施
1. 警告 → 限制下注额
2. 严重违规 → 冻结账户
3. 确认作弊 → 没收资金至保险基金
```

---

## 6. 玩法详细规则

### 6.1 玩法 A：数据狙击手

**适用事件**：CPI, NFP, GDP, Fed Rate 等

**容差标准表**：
```
| 数据类型 | 预期值示例 | 容差 | 鸽派判定 | 鹰派判定 | 中性判定 |
|---------|-----------|------|---------|---------|---------|
| CPI     | 3.2%      | 0.1% | < 3.1%  | > 3.3%  | 3.1%-3.3% |
| NFP     | 200K      | 10K  | < 190K  | > 210K  | 190K-210K |
| GDP     | 2.5%      | 0.1% | < 2.4%  | > 2.6%  | 2.4%-2.6% |
| Fed Rate| 5.25%     | 0.0% | < 5.25% | > 5.25% | = 5.25% |
```

**特殊说明**：
- Fed Rate 无容差，必须精确匹配
- NFP 以千人为单位，10K 容差合理
- 季度 GDP 修正值以初值为准

### 6.2 玩法 B：波动猎人

**波动阈值**：
```
标准阈值 = 2.0%

可调整阈值（根据事件重要性）：
- 高影响事件 (CPI, NFP, Fed Rate)：2.0%
- 中影响事件 (GDP, 零售销售)：1.5%
- 低影响事件 (其他)：1.0%
```

**价格采样详细规则**：
```javascript
// 基准价格：数据发布前 1 分钟的均价
function getBaselinePrice(releaseTime) {
  const startTime = releaseTime - 2 * 60;  // 前 2 分钟
  const endTime = releaseTime - 1 * 60;    // 前 1 分钟

  // 采集该时段的价格
  const prices = fetchPricesInRange(startTime, endTime);

  // 返回中位数
  return median(prices);
}

// 结算价格：数据发布后 15 分钟的均价
function getSettlementPrice(releaseTime) {
  const startTime = releaseTime + 14 * 60;  // 后 14 分钟
  const endTime = releaseTime + 15 * 60;    // 后 15 分钟

  const prices = fetchPricesInRange(startTime, endTime);
  return median(prices);
}
```

**多数据源验证**：
```javascript
// 必须至少 2/3 数据源价格在 0.5% 范围内
function validatePriceConsistency(prices) {
  const median = getMedian(prices);
  const threshold = median * 0.005;  // 0.5%

  let validCount = 0;
  for (const price of prices) {
    if (Math.abs(price - median) <= threshold) {
      validCount++;
    }
  }

  require(validCount >= prices.length * 2/3, "价格数据不一致");
  return median;
}
```

### 6.3 玩法 C：精准点位

**区间动态调整**：
```javascript
// 根据当前 BTC 价格动态设置区间
function generatePriceRanges(currentPrice) {
  const step = 1000;  // 区间宽度 $1,000

  return [
    { min: 0,                    max: currentPrice - 2000, name: `< $${(currentPrice - 2000)/1000}K` },
    { min: currentPrice - 2000,  max: currentPrice - 1000, name: `$${(currentPrice - 2000)/1000}K-${(currentPrice - 1000)/1000}K` },
    { min: currentPrice - 1000,  max: currentPrice,        name: `$${(currentPrice - 1000)/1000}K-${currentPrice/1000}K` },
    { min: currentPrice,         max: currentPrice + 1000, name: `$${currentPrice/1000}K-${(currentPrice + 1000)/1000}K` }, // 最热门
    { min: currentPrice + 1000,  max: currentPrice + 2000, name: `$${(currentPrice + 1000)/1000}K-${(currentPrice + 2000)/1000}K` },
    { min: currentPrice + 2000,  max: currentPrice + 3000, name: `$${(currentPrice + 2000)/1000}K-${(currentPrice + 3000)/1000}K` },
    { min: currentPrice + 3000,  max: Infinity,            name: `> $${(currentPrice + 3000)/1000}K` }
  ];
}

// 区间锁定时机
区间设置锁定时间 = 下注开放时刻
// 之后价格即使变化，区间也不再调整
```

**赔率上限保护**：
```javascript
// 防止极端赔率导致平台风险
const MAX_ODDS = 100;  // 最高 100 倍

function calculateOdds(totalPool, optionPool) {
  const rawOdds = totalPool / optionPool;
  return Math.min(rawOdds, MAX_ODDS);
}

// 如果计算赔率 > 100x，超出部分进入保险基金
```

---

## 7. 资金安全与合约

### 7.1 资金托管

```
用户下注资金流向：
用户钱包 → 智能合约托管 → 结算分配 → 用户钱包
          ↓
      多签控制
   (5/9 多签管理)
```

**安全措施**：
- ✅ 合约代码开源
- ✅ 多家机构审计（CertiK, SlowMist, Trail of Bits）
- ✅ Bug Bounty 计划（最高 $100K 奖励）
- ✅ 时间锁控制（升级需 7 天延迟）
- ✅ 紧急暂停机制

### 7.2 提取奖金

**提取流程**：
```
1. 事件结算完成
   ↓
2. 用户查看"已结算"订单
   ↓
3. 点击"提取奖金"
   ↓
4. 智能合约验证
   ↓
5. 奖金转入用户钱包
   ↓
6. 更新订单状态为"已提取"
```

**自动提取 vs 手动提取**：
```
自动提取（默认，推荐）：
✅ 结算后自动转入用户钱包
✅ 无需用户操作
✅ 节省用户 Gas 费（批量处理）

手动提取（可选）：
⚠️ 用户需主动点击"提取"
⚠️ 单独支付 Gas 费
✅ 用户自主控制
```

### 7.3 Gas 费优化

**批量结算**：
```javascript
// 合约优化：批量处理多个用户的奖金分配
function batchSettle(eventId, userAddresses) external {
  for (uint i = 0; i < userAddresses.length; i++) {
    // 批量计算和转账
    settleUser(eventId, userAddresses[i]);
  }
  // Gas 费由平台补贴
}
```

**Layer 2 方案（V2 规划）**：
```
迁移至 Arbitrum / Optimism：
- Gas 费降低 95%
- 交易确认加快
- 用户体验提升
```

### 7.4 保险基金

**基金来源**：
```
保险基金来源：
1. 平台手续费的 33% (1% / 3%)
2. 极端赔率超出部分
3. 违规作弊没收资金
4. 社区捐赠
```

**基金用途**：
```
1. 合约漏洞赔付
2. Oracle 故障补偿
3. 极端事件风险对冲
4. 争议退款储备
```

**基金透明度**：
```
✅ 链上公开地址
✅ 每月公开报告
✅ 多签管理（7/11 多签）
✅ 使用需社区投票
```

---

## 8. 用户界面示例

### 8.1 下注确认弹窗（完整版）

```
┌─────────────────────────────────────┐
│ 📋 确认下注信息                      │
│ ────────────────────────────────── │
│                                     │
│ 📅 事件：CPI 2026-02-14 21:30 UTC  │
│ 🎮 玩法：数据狙击手 (Data Sniper)   │
│ 🎯 预测：🕊️ 鸽派 (Dovish)           │
│     公布值 < 预期值 (3.2%)          │
│                                     │
│ ────────────────────────────────── │
│                                     │
│ 💰 下注金额                          │
│    100.00 USDT                      │
│                                     │
│ 📊 当前赔率                          │
│    2.85x (实时变动)                 │
│                                     │
│ 💎 预估总回报                        │
│    285.00 USDT                      │
│                                     │
│ 📈 预估净收益                        │
│    +185.00 USDT (+185%)            │
│                                     │
│ ────────────────────────────────── │
│                                     │
│ 📝 费用明细：                        │
│ • 平台手续费：已计入赔率 (3%)       │
│ • 预估 Gas 费：~0.5 USDT           │
│                                     │
│ ⚠️ 重要提示：                        │
│ • 赔率实时变动，以下注时为准        │
│ • 下注后不可修改或取消              │
│ • 结算时间：数据发布后 15-20 分钟   │
│                                     │
│ ────────────────────────────────── │
│                                     │
│ [ 取消 ]           [ 确认下注 ]    │
│                                     │
└─────────────────────────────────────┘
```

### 8.2 结算结果通知

**获胜通知**：
```
┌─────────────────────────────────────┐
│ 🎉 恭喜！预测成功                    │
│ ────────────────────────────────── │
│                                     │
│ 事件：CPI 2026-02-14                │
│ 玩法：数据狙击手                     │
│                                     │
│ 📊 公布结果：                        │
│ 预期值：3.2%                        │
│ 公布值：2.9% ← 鸽派 ✅              │
│                                     │
│ 💰 您的收益：                        │
│ 下注金额：100 USDT                  │
│ 获得奖金：278 USDT                  │
│ 净收益：+178 USDT (+178%) 🎊       │
│                                     │
│ ✅ 奖金已自动转入您的钱包            │
│                                     │
│ [ 查看详情 ]  [ 分享战绩 ]         │
└─────────────────────────────────────┘
```

**失败通知**：
```
┌─────────────────────────────────────┐
│ 😔 很遗憾，预测未中                  │
│ ────────────────────────────────── │
│                                     │
│ 事件：CPI 2026-02-14                │
│ 玩法：数据狙击手                     │
│                                     │
│ 📊 公布结果：                        │
│ 预期值：3.2%                        │
│ 公布值：3.6% ← 鹰派                │
│                                     │
│ 您的预测：鸽派 ❌                    │
│                                     │
│ 📉 本次亏损：                        │
│ 下注金额：100 USDT                  │
│ 损失：-100 USDT                     │
│                                     │
│ 💪 继续加油！下次机会：              │
│ NFP 数据 - 2 天后发布               │
│                                     │
│ [ 查看详情 ]  [ 参与下一场 ]       │
└─────────────────────────────────────┘
```

**退款通知**：
```
┌─────────────────────────────────────┐
│ 🔄 订单已退款                        │
│ ────────────────────────────────── │
│                                     │
│ 事件：GDP Q4 2025                   │
│ 玩法：精准点位                       │
│                                     │
│ 📊 结算结果：                        │
│ 结算价格：$55,800                   │
│ 您的预测：$52,000-53,000 ❌         │
│                                     │
│ ℹ️ 本次无人预测正确                 │
│ 所有用户已全额退款                  │
│                                     │
│ 💰 退款金额：                        │
│ 500 USDT ✅                         │
│                                     │
│ 📌 无手续费扣除                      │
│                                     │
│ [ 查看详情 ]                        │
└─────────────────────────────────────┘
```

---

## 9. 常见问题 (FAQ)

### Q1: 赔率会变化吗？
**A:** 是的。赔率基于 Pari-mutuel 模式，随着下注实时变化。您下注时看到的是预估赔率，实际赔率以**下注截止时**为准。

### Q2: 可以取消下注吗？
**A:** 不可以。一旦下注成功，无法修改或取消。这是为了保证奖金池的公平性。

### Q3: 如果没人猜对怎么办？
**A:** 仅在「精准点位」玩法中可能出现。如果无人猜对，所有用户将获得**100% 本金退款**，平台不收取手续费。

### Q4: 手续费是多少？
**A:** 平台手续费为 **3%**，从奖金池中扣除。此外需支付链上 Gas 费（约 0.5 USDT）。

### Q5: 多久能结算？
**A:** 正常情况下，数据发布后 **15-20 分钟**完成结算。极端情况最多不超过 24 小时。

### Q6: 可以同时下注多个选项吗？
**A:** 可以。您可以在同一玩法的不同选项下注（对冲策略），但总下注不能超过 50,000 USDT。

### Q7: 奖金如何提取？
**A:** 默认**自动提取**，结算后自动转入您的钱包。您也可以选择手动提取。

### Q8: 平台会作弊吗？
**A:** 不会。所有逻辑在**智能合约**中执行，代码开源可审计。数据由**去中心化 Oracle** 提供，平台无法操纵。

### Q9: 如果数据发布延迟怎么办？
**A:** 等待官方数据发布。如果超过 24 小时仍未发布，将启动投票决定是否退款。

### Q10: 有最低下注要求吗？
**A:** 最低 **10 USDT**，最高单笔 **10,000 USDT**。

---

## 10. 版本更新计划

### V1.0 (当前版本)
- ✅ 三种核心玩法
- ✅ 奖金池机制
- ✅ 3% 手续费
- ✅ 无人中奖退款
- ✅ 自动结算

### V1.1 (规划中)
- [ ] 动态波动阈值（根据事件调整）
- [ ] 精准点位智能区间（根据历史波动）
- [ ] 对冲策略推荐
- [ ] 更多宏观事件（失业率、零售销售等）

### V1.2 (未来)
- [ ] Layer 2 迁移（降低 Gas 费）
- [ ] 社交跟单功能
- [ ] VIP 会员（手续费折扣）
- [ ] 保险对冲产品

---

## 附录 A：计算公式汇总

```javascript
// 1. 总奖金池
总奖金池 = Σ(所有选项下注额) × (1 - 0.03)

// 2. 选项赔率
选项赔率 = 总奖金池 / 该选项下注总额

// 3. 用户奖金
用户奖金 = (用户下注额 / 获胜选项总下注额) × 总奖金池

// 4. 用户收益率
收益率 = (用户奖金 - 用户下注额) / 用户下注额 × 100%

// 5. 波动幅度
波动幅度 = |结算价格 - 基准价格| / 基准价格 × 100%

// 6. 平台手续费
平台手续费 = Σ(所有选项下注额) × 0.03
```

---

## 附录 B：风控参数表

| 参数 | 数值 | 说明 |
|------|------|------|
| 最小下注额 | 10 USDT | 防止刷量 |
| 最大下注额 | 10,000 USDT | 单笔限制 |
| 用户事件总限额 | 50,000 USDT | 防止过度风险 |
| 单玩法池上限 | 1,000,000 USDT | 平台风险控制 |
| 平台手续费率 | 3% | 运营成本 |
| 最高赔率 | 100x | 防止极端赔付 |
| 下注截止时间 | 发布前 5 分钟 | 防止内幕交易 |
| 价格采样延迟 | 15 分钟 | 价格稳定期 |
| 价格一致性阈值 | 0.5% | 多源验证 |
| Oracle 最少确认数 | 3/5 | 数据可靠性 |
| 争议期限 | 24 小时 | 结算后可申诉 |
| 最大结算延迟 | 24 小时 | SLA 承诺 |

---

**文档结束**

如有疑问，请联系团队：support@macroshockwave.com
