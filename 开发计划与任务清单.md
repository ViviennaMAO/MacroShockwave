# MacroShockwave 开发计划与任务清单

## 文档信息
- **版本**：V1.0
- **创建日期**：2026-01-17
- **项目周期**：9 周（MVP）
- **团队规模**：建议 5-7 人

---

## 📅 开发阶段总览

```
Phase 1: 基础设施搭建 (1周)
  ↓
Phase 2: 核心功能开发 (4周)
  ↓
Phase 3: 集成与测试 (2周)
  ↓
Phase 4: 优化与上线 (2周)
  ↓
🚀 MVP 上线
```

---

## Phase 1: 基础设施搭建 (第 1 周)

### 目标
搭建项目基础架构，完成开发环境配置

### 任务清单

#### 1.1 项目初始化
- [ ] 创建 Git 仓库（GitHub/GitLab）
- [ ] 设置分支策略（main, develop, feature/*）
- [ ] 配置 .gitignore 和代码规范
- [ ] 设置 CI/CD 流水线（GitHub Actions）

#### 1.2 前端项目搭建
```bash
# 技术栈
- React 18 + TypeScript
- Vite 构建工具
- Tailwind CSS
- Zustand 状态管理
```

**任务**：
- [ ] 使用 Vite 创建 React + TS 项目
- [ ] 配置 Tailwind CSS
- [ ] 安装 Zustand, React Router
- [ ] 设置 ESLint + Prettier
- [ ] 配置路径别名 (@/components, @/utils 等)
- [ ] 创建基础项目结构（参考技术架构文档）
- [ ] 设置环境变量管理 (.env.local)

**产出**：
```
frontend/
├── src/
│   ├── app/
│   ├── pages/
│   ├── components/
│   ├── stores/
│   ├── hooks/
│   ├── services/
│   ├── utils/
│   └── types/
├── public/
├── package.json
├── vite.config.ts
├── tailwind.config.js
└── tsconfig.json
```

#### 1.3 后端项目搭建
```bash
# 技术栈
- Node.js 20 + TypeScript
- Express / Nest.js
- PostgreSQL + Prisma ORM
- Redis
```

**任务**：
- [ ] 使用 Nest.js CLI 创建项目
- [ ] 配置 Prisma ORM
- [ ] 设置 PostgreSQL 数据库
- [ ] 配置 Redis 连接
- [ ] 设置环境变量管理
- [ ] 创建基础模块结构
- [ ] 配置日志系统（Winston）

**产出**：
```
backend/
├── src/
│   ├── modules/
│   ├── common/
│   ├── config/
│   ├── jobs/
│   └── utils/
├── prisma/
│   └── schema.prisma
├── package.json
└── tsconfig.json
```

#### 1.4 智能合约项目搭建
```bash
# 技术栈
- Solidity 0.8.20+
- Hardhat / Foundry
- OpenZeppelin Contracts
```

**任务**：
- [ ] 使用 Hardhat 创建项目
- [ ] 安装 OpenZeppelin 合约库
- [ ] 配置测试网络（Sepolia/Goerli）
- [ ] 设置合约部署脚本
- [ ] 配置 Slither 安全检查
- [ ] 创建基础合约结构

**产出**：
```
contracts/
├── contracts/
│   ├── core/
│   ├── oracle/
│   ├── governance/
│   └── interfaces/
├── scripts/
├── test/
├── hardhat.config.ts
└── package.json
```

#### 1.5 Docker 环境配置
**任务**：
- [ ] 编写 Dockerfile（前端、后端）
- [ ] 配置 docker-compose.yml
- [ ] 设置开发环境一键启动
- [ ] 配置数据库初始化脚本

**产出**：
```yaml
docker-compose.yml
├── frontend (port 3000)
├── backend (port 4000)
├── postgres (port 5432)
└── redis (port 6379)
```

#### 1.6 文档与规范
**任务**：
- [ ] 编写 README.md
- [ ] 创建开发文档（如何运行、如何部署）
- [ ] 定义代码提交规范（Conventional Commits）
- [ ] 设置 PR 模板
- [ ] 创建 API 文档框架（Swagger/OpenAPI）

---

## Phase 2: 核心功能开发 (第 2-5 周)

### Week 2: 用户系统 + 事件管理

#### 2.1 Luffa SDK 集成（前端）
**优先级**：🔴 最高

**任务**：
- [ ] 集成 Luffa SuperBox SDK
- [ ] 实现 `useLuffa` Hook
  - [ ] 获取用户账户信息（getAccount）
  - [ ] 监听账户变化（accountChanged）
  - [ ] 发送交易（sendTransaction）
  - [ ] 设置分享信息（setShareInfo）
- [ ] 创建钱包连接组件
- [ ] 处理未登录状态

**验收标准**：
- ✅ 用户能在 Luffa 应用中打开小程序
- ✅ 自动获取用户地址和用户名
- ✅ 顶部显示登录状态

#### 2.2 用户系统（后端）
**任务**：
- [ ] 实现用户表（Prisma Schema）
- [ ] 创建 User 模块（Controller + Service）
- [ ] 实现用户信息获取 API
- [ ] 实现用户统计数据 API
- [ ] 添加用户认证中间件（验证签名）

**API 端点**：
```
GET  /api/users/me
GET  /api/users/me/stats
GET  /api/users/me/portfolio
```

#### 2.3 事件管理系统（后端）
**任务**：
- [ ] 设计事件表结构（Prisma Schema）
- [ ] 创建 Event 模块
- [ ] 实现事件 CRUD API
- [ ] 实现事件状态机（OPEN → BETTING → LOCKED → SETTLED）
- [ ] 创建事件定时任务
  - [ ] 自动开放下注（发布前7天）
  - [ ] 自动锁定下注（发布前5分钟）
- [ ] 设置 Redis 缓存（事件列表缓存30秒）

**API 端点**：
```
GET  /api/events               # 获取即将发布的事件
GET  /api/events/:id           # 获取事件详情
POST /api/events               # 创建事件（管理员）
PUT  /api/events/:id           # 更新事件
```

#### 2.4 事件列表页面（前端）
**任务**：
- [ ] 创建 Home 页面
- [ ] 实现事件卡片组件（EventCard）
  - [ ] 显示事件信息（名称、时间、预期值、前值）
  - [ ] 显示倒计时
  - [ ] 显示总下注池和参与人数
- [ ] 实现事件列表（EventList）
- [ ] 添加事件状态标识
- [ ] 集成 WebSocket 实时更新

**UI 组件**：
```typescript
<EventCard
  event={event}
  onJoin={() => navigate(`/event/${event.id}`)}
/>
```

### Week 3: 下注系统 - 玩法 A（数据狙击手）

#### 3.1 奖金池系统（后端）
**任务**：
- [ ] 设计 Pool 和 Option 表结构
- [ ] 实现奖金池创建和管理
- [ ] 实现实时赔率计算
  - [ ] Pari-mutuel 赔率算法
  - [ ] 扣除 3% 手续费
- [ ] 实现奖金池缓存（Redis）
- [ ] 创建赔率实时推送（WebSocket）

**核心算法**：
```typescript
function calculateOdds(pool: Pool): Map<string, number> {
  const totalPool = pool.totalAmount * 0.97; // 扣除3%
  const oddsMap = new Map();

  pool.options.forEach(option => {
    if (option.totalAmount > 0) {
      oddsMap.set(option.id, totalPool / option.totalAmount);
    } else {
      oddsMap.set(option.id, 0);
    }
  });

  return oddsMap;
}
```

#### 3.2 下注系统（后端）
**任务**：
- [ ] 设计 Order 表结构
- [ ] 创建 Bet 模块
- [ ] 实现下注 API
  - [ ] 验证下注金额（10-10,000 USDT）
  - [ ] 验证用户限额（单事件 50,000 USDT）
  - [ ] 验证事件状态（是否可下注）
  - [ ] 验证时间窗口（截止前5分钟）
- [ ] 实现订单确认（验证 txHash）
- [ ] 更新奖金池和赔率
- [ ] 广播奖金池更新（WebSocket）

**API 端点**：
```
POST /api/bets                 # 创建下注订单
POST /api/bets/:id/confirm     # 确认订单（提交txHash）
GET  /api/bets/:id             # 获取订单详情
```

#### 3.3 玩法 A 页面（前端）
**任务**：
- [ ] 创建事件详情页（EventDetail）
- [ ] 实现玩法选择（Tab 切换）
- [ ] 实现数据狙击手界面（GameModeA）
  - [ ] 三个选项（鸽派、中性、鹰派）
  - [ ] 实时赔率显示
  - [ ] 下注占比进度条
  - [ ] 下注金额输入
  - [ ] 预计收益计算
- [ ] 实现下注确认弹窗
  - [ ] 显示完整下注信息
  - [ ] 费用明细（3% + Gas）
  - [ ] 重要提示
- [ ] 集成 Luffa 钱包调用
- [ ] 交易状态追踪

**核心组件**：
```typescript
<GameModeA
  event={event}
  pool={pool}
  onBet={(option, amount) => handleBet(option, amount)}
/>
```

#### 3.4 智能合约 - 下注功能
**任务**：
- [ ] 实现 `placeBet` 函数
  - [ ] 金额验证
  - [ ] 用户限额检查
  - [ ] 事件状态验证
  - [ ] 时间窗口验证
- [ ] 实现订单存储
- [ ] 实现奖金池更新
- [ ] 添加事件日志（BetPlaced）
- [ ] 编写单元测试
- [ ] 测试网部署和测试

### Week 4: 玩法 B & C + 结算系统

#### 4.1 玩法 B：波动猎人（前端 + 后端）
**任务**：
- [ ] 创建玩法 B 的 Pool 结构
- [ ] 实现波动猎人界面（GameModeB）
  - [ ] 两个选项（风平浪静、惊涛骇浪）
  - [ ] 波动阈值说明（2%）
  - [ ] 实时赔率显示
- [ ] 后端支持玩法 B 下注
- [ ] 智能合约支持玩法 B

#### 4.2 玩法 C：精准点位（前端 + 后端）
**任务**：
- [ ] 实现价格区间动态生成
  - [ ] 基于当前 BTC 价格
  - [ ] 7 个区间，每个 $1,000 宽度
- [ ] 实现精准点位界面（GameModeC）
  - [ ] 显示当前 BTC 价格
  - [ ] 7 个价格区间选择
  - [ ] 每个区间显示赔率
- [ ] 后端支持玩法 C 下注
- [ ] 智能合约支持玩法 C

#### 4.3 Oracle 服务（后端）
**任务**：
- [ ] 创建 Oracle 模块
- [ ] 实现数据 Oracle
  - [ ] 对接宏观数据 API（Trading Economics）
  - [ ] 数据验证和存储
- [ ] 实现价格 Oracle
  - [ ] 对接 Binance WebSocket
  - [ ] 对接 Coinbase API
  - [ ] 对接 Kraken API
  - [ ] 多数据源取中位数
  - [ ] 价格一致性验证（0.5% 误差内）
- [ ] 实现 Oracle 数据提交到合约
- [ ] 添加 Oracle 监控和告警

#### 4.4 结算系统（后端 + 合约）
**任务**：
- [ ] 实现结算服务（Settlement Service）
- [ ] 实现三种玩法的结算逻辑
  - [ ] 玩法 A：数据狙击手结算
  - [ ] 玩法 B：波动猎人结算
  - [ ] 玩法 C：精准点位结算
- [ ] 实现无人中奖退款逻辑
- [ ] 实现批量奖金分配
- [ ] 智能合约结算函数
  - [ ] `settleEvent(eventId, winningOptionId)`
  - [ ] 奖金计算和分配
  - [ ] 自动转账
- [ ] 添加结算任务调度
- [ ] 编写结算测试用例

**核心流程**：
```typescript
async function settleEvent(eventId: string) {
  // 1. 获取 Oracle 数据（15分钟延迟）
  const oracleData = await oracle.getEventResult(eventId);

  // 2. 确定获胜选项
  const winningOption = determineWinner(event, oracleData);

  // 3. 计算奖金
  const totalPool = pool.totalAmount * 0.97;

  // 4. 分配奖金或退款
  if (winningOption.totalAmount === 0) {
    await refundAll(pool); // 无人中奖
  } else {
    await distributeWinnings(pool, winningOption, totalPool);
  }

  // 5. 更新状态
  await updateEventStatus(eventId, 'SETTLED');
}
```

### Week 5: Portfolio 页面 + 通知系统

#### 5.1 Portfolio 概览（前端）
**任务**：
- [ ] 创建 Portfolio 页面
- [ ] 实现资产概览卡片
  - [ ] 总价值
  - [ ] 现金余额
  - [ ] 未结订单价值
  - [ ] 24h 涨跌
- [ ] 实现盈亏统计
  - [ ] 时间筛选（1D/1W/1M/ALL）
  - [ ] 盈亏曲线图（Recharts）
  - [ ] 总收益和收益率
  - [ ] 胜率统计

#### 5.2 持仓管理（前端）
**任务**：
- [ ] 实现 Tab 切换（Positions / Open Orders / History）
- [ ] Positions 列表
  - [ ] 显示未结算订单
  - [ ] 实时赔率更新
  - [ ] 倒计时显示
- [ ] Open Orders 列表
  - [ ] 与 Positions 相同
  - [ ] 排序功能
- [ ] History 列表
  - [ ] 已结算订单
  - [ ] 成功/失败标识
  - [ ] 收益显示
  - [ ] 筛选功能（状态、玩法、事件类型、时间）

#### 5.3 用户统计（后端）
**任务**：
- [ ] 实现用户统计计算
  - [ ] 总下注次数
  - [ ] 总胜/败次数
  - [ ] 胜率
  - [ ] 总下注金额
  - [ ] 总收益金额
- [ ] 实现盈亏历史记录
- [ ] 实现数据缓存（Redis）

#### 5.4 通知系统
**任务**：
- [ ] 设计通知表结构
- [ ] 实现通知服务
  - [ ] 下注成功通知
  - [ ] 下注失败通知
  - [ ] 事件即将锁定通知（提前10分钟）
  - [ ] 结算完成通知（获胜/失败/退款）
- [ ] 前端 Toast 组件
- [ ] WebSocket 推送通知

---

## Phase 3: 集成与测试 (第 6-7 周)

### Week 6: 系统集成测试

#### 6.1 端到端测试
**任务**：
- [ ] 完整下注流程测试
  - [ ] 用户登录
  - [ ] 选择事件
  - [ ] 选择玩法和选项
  - [ ] 输入金额
  - [ ] 确认下注
  - [ ] 等待交易确认
  - [ ] 查看持仓
- [ ] 结算流程测试
  - [ ] 等待数据发布
  - [ ] Oracle 提交数据
  - [ ] 触发结算
  - [ ] 奖金分配
  - [ ] 查看历史记录
- [ ] 特殊场景测试
  - [ ] 无人中奖退款
  - [ ] 数据延迟处理
  - [ ] 多数据源冲突
  - [ ] 极端市场波动

#### 6.2 性能测试
**任务**：
- [ ] 前端性能优化
  - [ ] 首屏加载时间 < 2s
  - [ ] 页面切换动画 60fps
  - [ ] 图片懒加载
  - [ ] 代码分割
- [ ] 后端性能测试
  - [ ] API 响应时间 < 500ms
  - [ ] 并发用户测试（100+）
  - [ ] 数据库查询优化
  - [ ] Redis 缓存命中率
- [ ] 智能合约 Gas 优化
  - [ ] 批量操作优化
  - [ ] 存储优化

#### 6.3 安全测试
**任务**：
- [ ] 智能合约审计
  - [ ] 使用 Slither 静态分析
  - [ ] 使用 Mythril 安全检查
  - [ ] 手动代码审查
  - [ ] 重入攻击测试
  - [ ] 整数溢出测试
- [ ] API 安全测试
  - [ ] SQL 注入测试
  - [ ] XSS 攻击测试
  - [ ] CSRF 防护验证
  - [ ] 频率限制测试
- [ ] 前端安全
  - [ ] 输入验证
  - [ ] 敏感信息保护

### Week 7: Bug 修复与优化

#### 7.1 Bug 修复
**任务**：
- [ ] 整理测试发现的所有 Bug
- [ ] 按优先级修复（P0 → P1 → P2）
- [ ] 回归测试

#### 7.2 用户体验优化
**任务**：
- [ ] 添加 Loading 状态
- [ ] 添加骨架屏
- [ ] 优化错误提示
- [ ] 优化交互反馈
- [ ] 添加帮助提示（Tooltip）
- [ ] 完善空状态页面

#### 7.3 文档完善
**任务**：
- [ ] 完善 API 文档（Swagger）
- [ ] 编写用户使用指南
- [ ] 编写智能合约文档
- [ ] 录制演示视频

---

## Phase 4: 优化与上线 (第 8-9 周)

### Week 8: 上线准备

#### 8.1 生产环境部署
**任务**：
- [ ] 配置生产环境变量
- [ ] 前端部署（Vercel）
- [ ] 后端部署（AWS / GCP）
- [ ] 数据库迁移（RDS）
- [ ] Redis 配置（ElastiCache）
- [ ] CDN 配置（Cloudflare）
- [ ] SSL 证书配置
- [ ] 域名配置

#### 8.2 智能合约部署
**任务**：
- [ ] 主网部署前最后审计
- [ ] 部署到主网
- [ ] 验证合约代码（Etherscan）
- [ ] 配置 Oracle 地址
- [ ] 配置多签管理员
- [ ] 转移合约所有权

#### 8.3 监控和告警
**任务**：
- [ ] 配置 Grafana 监控面板
- [ ] 设置 Prometheus 指标收集
- [ ] 配置 ELK 日志系统
- [ ] 设置告警规则
  - [ ] API 错误率 > 5%
  - [ ] 数据库连接池满
  - [ ] Redis 内存使用 > 80%
  - [ ] 合约余额不足
- [ ] 配置 PagerDuty / Slack 通知

#### 8.4 数据备份
**任务**：
- [ ] 配置数据库自动备份（每日）
- [ ] 配置 Redis 持久化
- [ ] 设置灾难恢复计划
- [ ] 测试数据恢复流程

### Week 9: 灰度发布与运营准备

#### 9.1 灰度发布
**任务**：
- [ ] 小范围内测（10-20 用户）
- [ ] 收集反馈
- [ ] 修复紧急问题
- [ ] 逐步扩大用户规模

#### 9.2 运营准备
**任务**：
- [ ] 编写产品介绍文档
- [ ] 制作宣传物料
- [ ] 准备首次事件
  - [ ] CPI 数据事件
  - [ ] 设置初始奖金池（平台补贴）
- [ ] 设置客服支持
- [ ] 准备 FAQ 文档

#### 9.3 上线检查清单
**最终检查**：
- [ ] ✅ 所有功能正常运行
- [ ] ✅ 智能合约已审计
- [ ] ✅ 性能指标达标
- [ ] ✅ 安全测试通过
- [ ] ✅ 监控系统正常
- [ ] ✅ 备份系统配置
- [ ] ✅ 文档齐全
- [ ] ✅ 客服团队就绪

#### 9.4 正式上线 🚀
**上线流程**：
1. 发布公告（Luffa 社区）
2. 开放小程序访问
3. 实时监控系统状态
4. 快速响应用户反馈
5. 每日数据统计和分析

---

## 📊 团队分工建议

### 角色配置（5-7人团队）

```
👨‍💼 项目经理 (PM) × 1
├─ 项目进度管理
├─ 需求确认和优先级
└─ 团队协调

👨‍🎨 UI/UX 设计师 × 1
├─ 界面设计
├─ 交互原型
└─ 设计规范

👨‍💻 前端工程师 × 2
├─ React 开发
├─ Luffa SDK 集成
└─ UI 组件实现

👨‍💻 后端工程师 × 2
├─ API 开发
├─ 数据库设计
├─ Oracle 服务
└─ 结算系统

👨‍💻 智能合约工程师 × 1
├─ Solidity 开发
├─ 合约测试
└─ 合约部署

🧪 测试工程师 × 1 (可选)
├─ 功能测试
├─ 性能测试
└─ 安全测试
```

---

## 🎯 关键里程碑

```
Week 1  ✅ 基础设施搭建完成
Week 2  ✅ 用户系统 + 事件管理完成
Week 3  ✅ 玩法 A 完成
Week 4  ✅ 玩法 B/C + 结算系统完成
Week 5  ✅ Portfolio 页面完成
Week 6  ✅ 集成测试完成
Week 7  ✅ Bug 修复和优化完成
Week 8  ✅ 生产环境部署完成
Week 9  ✅ MVP 正式上线 🚀
```

---

## 📈 成功指标

### 技术指标
- ✅ 首屏加载时间 < 2s
- ✅ API 响应时间 < 500ms
- ✅ 系统可用性 > 99.9%
- ✅ 智能合约 Gas 优化良好

### 业务指标（上线 1 个月）
- 🎯 DAU > 500
- 🎯 总下注金额 > $100,000
- 🎯 用户留存率 (D7) > 30%
- 🎯 平均下注额 > $50

---

## 🔄 迭代计划（MVP 后）

### V1.1 (上线后 1-2 个月)
- [ ] 动态波动阈值
- [ ] 智能区间推荐
- [ ] 更多宏观事件（失业率、零售销售）
- [ ] 推荐返佣系统
- [ ] 成就徽章系统

### V1.2 (上线后 3-4 个月)
- [ ] Layer 2 迁移（降低 Gas 费）
- [ ] 社交跟单功能
- [ ] VIP 会员体系
- [ ] 排行榜系统

### V2.0 (上线后 6 个月)
- [ ] DAO 治理
- [ ] 策略分享市场
- [ ] 移动端原生应用
- [ ] 更多资产预测（ETH, 黄金等）

---

## 📝 每日站会模板

```markdown
# 每日站会 - YYYY-MM-DD

## 昨天完成
- [ ] 任务 1
- [ ] 任务 2

## 今天计划
- [ ] 任务 1
- [ ] 任务 2

## 遇到的问题
- 问题描述
- 需要的支持

## 风险提示
- 风险 1
- 风险 2
```

---

## 🚨 风险管理

### 技术风险
| 风险 | 影响 | 应对措施 |
|------|------|---------|
| 智能合约漏洞 | 🔴 高 | 多次审计、Bug Bounty |
| Oracle 故障 | 🟡 中 | 多数据源、备用方案 |
| 性能瓶颈 | 🟡 中 | 提前压测、优化 |
| 第三方 API 不稳定 | 🟢 低 | 备用数据源 |

### 进度风险
| 风险 | 影响 | 应对措施 |
|------|------|---------|
| 需求变更 | 🟡 中 | 严格评审、版本控制 |
| 人员变动 | 🟡 中 | 文档齐全、知识共享 |
| 延期 | 🟡 中 | 每周评估、及时调整 |

---

## ✅ 完成标准

每个任务完成需满足：
1. ✅ 代码已提交并 Code Review
2. ✅ 单元测试通过（覆盖率 > 80%）
3. ✅ 功能测试通过
4. ✅ 文档已更新

---

**文档维护**：
- 每周更新进度
- 每日更新任务状态
- 及时记录风险和问题

**下一步**：开始 Phase 1 任务，搭建项目基础设施！
