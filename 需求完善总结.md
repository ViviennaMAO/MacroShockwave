# MacroShockwave 需求完善总结

## 📋 文档更新概览

### 已创建的文档
1. ✅ **PRD_详细版.md** - 完整产品需求文档（已更新）
2. ✅ **下注与结算规则详细说明.md** - 核心业务规则文档（新建）
3. ✅ **需求完善总结.md** - 本文档

---

## 🎯 重点完善内容

### 1. 奖金池机制详细设计

#### 奖金池构成
```
每个事件的每个玩法都有独立的奖金池

总奖金池 = Σ(所有选项下注总额) × (1 - 3%)
         = 所有下注 × 0.97

示例：
总下注 30,000 USDT
平台手续费 = 30,000 × 3% = 900 USDT
总奖金池 = 30,000 - 900 = 29,100 USDT
```

#### 奖金分配规则
```javascript
// 赢家瓜分奖金池
用户获得奖金 = (用户下注额 / 获胜选项总下注额) × 总奖金池

// 示例
获胜选项（鹰派）总下注：15,000 USDT
用户 A 下注：1,500 USDT
总奖金池：29,100 USDT

用户 A 获得 = (1,500 / 15,000) × 29,100 = 2,910 USDT
用户 A 收益 = 2,910 - 1,500 = 1,410 USDT
用户 A 收益率 = 94%
```

#### 实时赔率计算
```javascript
选项赔率 = 总奖金池 / 该选项当前下注总额

特点：
- 实时动态变化
- 用户下注时显示预估赔率
- 实际赔率以下注截止时为准
- 赔率会因新下注而改变
```

---

### 2. 手续费规则

#### 费率设定
```
平台手续费 = 3% （从总下注额中扣除）
Gas 费 = 用户自行承担（根据链上实际消耗，约 0.5 USDT）
```

#### 手续费收取时机
```
下注时：
- 用户支付：下注金额 + Gas 费
- 进入奖金池：下注金额全额（先进池）
- 平台收取：结算时从奖金池统一扣除 3%
```

#### 手续费用途
```
3% 平台手续费分配：
├─ 1.5% → 运营成本（服务器、数据源、开发维护）
├─ 1.0% → 保险基金（应对极端情况、合约漏洞）
└─ 0.5% → 治理基金（DAO 预留，未来社区治理）
```

#### 手续费透明度
- ✅ 每个事件页面显示总手续费收取
- ✅ 用户订单详情显示手续费占比
- ✅ 平台定期公开手续费使用报告
- ✅ 保险基金链上公开地址

---

### 3. 下注要求详细规则

#### 下注金额限制
```javascript
// 单笔限制
最小下注额 = 10 USDT          // 防止刷量
最大下注额 = 10,000 USDT      // 单笔单选项限制

// 用户限制
单用户单事件总限额 = 50,000 USDT  // 所有玩法合计

// 平台限制
单事件单玩法池上限 = 1,000,000 USDT  // 达到后停止接受下注
```

#### 下注时间窗口
```
事件生命周期：

[待开放]
  ↓ 事件发布前 7 天开放
[下注中] ← 可以下注
  ↓ 数据发布前 5 分钟
[即将锁定] ← 最后 5 分钟，红色警告闪烁
  ↓ 数据发布时刻
[已锁定] ← 禁止下注
  ↓ 等待数据公布
[数据发布]
  ↓ 15 分钟延迟（价格稳定）
[结算中]
  ↓ 智能合约计算
[已结算] ← 用户可提取奖金
```

#### 下注修改规则
```
❌ 下注后不可修改
❌ 下注后不可取消
✅ 可在同一事件追加新下注（遵守总额限制）
✅ 可在不同选项下注（对冲策略）
✅ 可在不同玩法下注
```

**原因说明**：
- 保证奖金池公平性
- 防止用户根据赔率变化反悔
- 符合预测市场标准规则

#### 多次下注与对冲
```
允许场景：
✅ 同一事件，不同玩法下注
✅ 同一玩法，不同选项下注（对冲）
✅ 同一选项，多次追加下注

对冲示例：
用户在 CPI 事件「数据狙击手」中：
- 鸽派下注 5,000 USDT (赔率 2.0x)
- 鹰派下注 5,000 USDT (赔率 2.0x)

结果分析：
- 鸽派赢 → 获得 10,000 USDT → 盈亏 ±0
- 鹰派赢 → 获得 10,000 USDT → 盈亏 ±0
- 中性赢 → 两边都输 → 亏损 10,000 USDT

💡 对冲策略可降低风险，但也降低收益潜力
```

---

### 4. 结算规则详细说明

#### 结算触发条件
```javascript
结算必须满足所有条件：
1. ✅ 官方数据已正式发布
2. ✅ 数据来源已通过 Oracle 验证
3. ✅ BTC 价格已稳定（15 分钟后）
4. ✅ 多数据源确认一致（至少 3/5 Oracle 节点）

结算时间线：
T0: 数据发布
  ↓ 等待 15 分钟
T0+15min: 价格采样（多交易所取中位数）
  ↓ Oracle 提交数据
链上验证: 3/5 Oracle 节点确认
  ↓ 智能合约计算
自动分配: 奖金自动转入用户钱包
```

#### 玩法 A：数据狙击手结算

```javascript
// 步骤 1：获取数据
预期值 = 3.2% (事件预期 CPI)
公布值 = 3.5% (官方公布 CPI)
容差 = 0.1% (CPI 容差标准)

// 步骤 2：判定结果
if (公布值 < 预期值 - 容差) → 鸽派
if (公布值 > 预期值 + 容差) → 鹰派
else → 中性

// 本例：3.5% > 3.2% + 0.1% = 3.3% → 鹰派获胜

// 步骤 3：分配奖金
总奖金池 = 29,100 USDT
鹰派下注总额 = 15,000 USDT

用户 A 鹰派下注 3,000 USDT
→ 获得 (3,000 / 15,000) × 29,100 = 5,820 USDT
→ 收益 5,820 - 3,000 = 2,820 USDT (94% ROI)
```

**容差标准表**：
```
| 数据类型 | 容差  | 判定规则 |
|---------|-------|---------|
| CPI     | 0.1%  | 3.2% ± 0.1% |
| NFP     | 10K   | 200K ± 10K |
| GDP     | 0.1%  | 2.5% ± 0.1% |
| Fed Rate| 0.0%  | 精确匹配 |
```

#### 玩法 B：波动猎人结算

```javascript
// 价格采样
基准价格 = 数据发布前 1 分钟均价
结算价格 = 数据发布后 15 分钟均价

// 多数据源验证（防止操纵）
prices = [
  Binance: $49,820,
  Coinbase: $49,780,
  Kraken: $49,800
]
结算价格 = median(prices) = $49,800

// 波动计算
基准价格 = $48,500
波动幅度 = |49,800 - 48,500| / 48,500 × 100% = 2.68%

// 判定
if (波动幅度 < 2.0%) → 风平浪静
else → 惊涛骇浪

// 本例：2.68% ≥ 2.0% → 惊涛骇浪获胜
```

**价格数据源**：
- 主数据源：Binance BTC/USDT
- 备用数据源：Coinbase, Kraken
- 取样方式：中位数（防止异常波动）
- 一致性要求：至少 2/3 数据源在 0.5% 误差内

#### 玩法 C：精准点位结算

```javascript
// 价格区间设置（基于下注开放时的 BTC 价格）
当前价格 = $48,523

区间划分：
1. < $46,000
2. $46,000 - $47,000
3. $47,000 - $48,000
4. $48,000 - $49,000  ← 最热门
5. $49,000 - $50,000
6. $50,000 - $51,000
7. > $51,000

// 结算价格
结算价格 = $49,450

// 判定中奖区间
$49,450 在区间 5 ($49,000-50,000) ✅

// 分配奖金
总奖金池 = 47,530 USDT
区间 5 下注总额 = 8,500 USDT

用户 D 下注 500 USDT
→ 获得 (500 / 8,500) × 47,530 = 2,796 USDT
→ 收益 2,796 - 500 = 2,296 USDT (459% ROI) 🎉
```

**区间特性**：
- 区间宽度：$1,000
- 区间数量：7 个
- 区间锁定：下注开放时锁定，之后不再调整
- 最高赔率：100x（超出部分进入保险基金）

---

### 5. 无人中奖退款机制

#### 适用范围
```
仅适用于「玩法 C：精准点位」

玩法 A 和 B 必然有人中奖（选项少，覆盖所有可能性）
玩法 C 可能出现价格落在无人下注的区间
```

#### 退款规则
```
触发条件：
中奖区间下注总额 = 0

处理方式：
✅ 所有用户获得 100% 本金退回
✅ 平台不收取 3% 手续费
❌ 不补偿 Gas 费（用户自行承担原下注时的 Gas）

退款流程：
智能合约检测无人中奖
  ↓
自动触发 refundAll() 函数
  ↓
遍历所有用户订单
  ↓
原路退回下注金额
  ↓
更新订单状态为「已退款」
```

#### 退款示例
```
事件：CPI 2026-03-14
玩法：精准点位

区间下注情况：
区间 1-6：共 50,000 USDT（200 位用户）
区间 7 (> $55,000)：200 USDT（2 位用户）

结算价格：$55,800

结果：
价格超出区间 7 的上限（$56,000）
→ 实际上所有区间都未命中 ❌

处理：
✅ 全部 202 位用户获得 100% 退款
✅ 总退款：50,200 USDT
✅ 平台不收 3% 手续费
```

#### 未来优化（V1.1）
```
为降低无人中奖频率：
1. 动态调整区间宽度（根据市场波动率）
2. 增加兜底区间（"其他价格"选项）
3. 智能区间设置（基于历史数据）
4. 提供区间推荐（AI 辅助）
```

---

### 6. 特殊情况处理

#### 情况 1：数据未发布或延迟
```
延迟 < 24 小时：
→ 等待数据发布，延长结算时间
→ 用户订单保持有效

延迟 > 24 小时：
→ 平台发起多签投票
→ 3/5 多签决定：继续等待 or 全额退款

数据取消发布：
→ 全额退款所有用户
→ 不收取手续费
```

#### 情况 2：极端市场波动
```
触发条件：
- BTC 单日波动 > 30%
- 15 分钟内波动 > 10%

处理措施：
1. 暂停新事件开放
2. 现有订单正常结算
3. 启动价格异常检测
4. 多数据源交叉验证（至少 5 个源）
5. 延长结算时间至价格稳定
6. 必要时人工审核
```

#### 情况 3：智能合约暂停
```
触发场景：
- 发现合约漏洞
- 遭受攻击
- 异常交易检测

紧急暂停流程：
1. 多签管理员触发 pause()
2. 立即停止所有下注
3. 现有订单冻结
4. 安全团队调查和修复
5. 第三方审计通过
6. 恢复运营

用户选择：
- 继续持有订单（等待结算）
- 申请退款（无手续费）
```

#### 情况 4：Oracle 故障
```
备用方案（按优先级）：
1. 主 Oracle：Chainlink
2. 备用 1：Band Protocol
3. 备用 2：API3
4. 备用 3：DIA
5. 最后方案：人工多签提交（7/11 多签）

要求：
- 至少 3/5 Oracle 节点确认
- 数据一致性验证（误差 < 0.5%）
- 时间戳在允许范围内（±2 分钟）
```

#### 情况 5：结算争议
```
争议流程：
1. 用户提交争议（结算后 24 小时内）
   ↓
2. 平台审核团队调查
   - 调取多数据源证据
   - 检查 Oracle 提交记录
   - 验证价格采样时间
   ↓
3. 3 个工作日内给出结论
   ↓
4. 处理结果：
   - 确认错误：重新结算 + 受影响用户补偿
   - 无误：维持原结果，公开证据

重新结算机制：
- 仅治理多签可执行
- 仅限结算后 7 天内
- 需公开说明原因
- 补偿受影响用户
```

---

### 7. 结算时间保证（SLA）

#### 正常情况
```
承诺时间：数据发布后 15-20 分钟内完成结算

时间分解：
T0: 数据发布
T0+15min: 价格采样
T0+16min: Oracle 提交
T0+18min: 链上验证和计算
T0+20min: 批量转账完成 ✅
```

#### 异常情况
```
数据源延迟：最多等待 2 小时
多数据源冲突：人工介入审核（4 小时内）
Oracle 故障：启用备用 Oracle（1 小时内）
链上拥堵：提高 Gas 费优先处理（30 分钟内）

最大延迟：24 小时

超时应急措施：
- 超过 24 小时启用紧急多签结算
- 公开说明延迟原因
- 向受影响用户道歉并补偿 Gas 费
```

---

### 8. 资金安全机制

#### 智能合约安全
```
✅ 合约代码完全开源
✅ 多家机构审计（CertiK, SlowMist, Trail of Bits）
✅ Bug Bounty 计划（最高 $100,000 奖励）
✅ 时间锁控制（合约升级需 7 天延迟）
✅ 紧急暂停机制（多签控制）
✅ ReentrancyGuard（防止重入攻击）
✅ SafeMath（防止整数溢出）
```

#### 资金托管
```
用户资金流向：
用户钱包 → 智能合约托管 → 结算分配 → 用户钱包
            ↓
        多签控制
     (5/9 多签管理)

特点：
- 用户资金完全在链上
- 平台无法动用用户资金
- 透明可审计
```

#### 保险基金
```
基金来源：
1. 平台手续费的 33% (1% / 3%)
2. 极端赔率超出 100x 的部分
3. 违规作弊没收资金
4. 社区捐赠

基金用途：
1. 合约漏洞赔付
2. Oracle 故障补偿
3. 极端事件风险对冲
4. 争议退款储备

透明度：
✅ 链上公开地址
✅ 每月公开报告
✅ 多签管理（7/11 多签）
✅ 使用需社区投票（> 50% 同意）
```

---

## 📊 核心公式汇总

### 奖金池与赔率
```javascript
// 1. 总奖金池
总奖金池 = Σ(所有选项下注额) × 0.97

// 2. 选项赔率
选项赔率 = 总奖金池 / 该选项下注总额

// 3. 用户奖金
用户奖金 = (用户下注额 / 获胜选项总下注额) × 总奖金池

// 4. 用户收益率
收益率 = (用户奖金 - 用户下注额) / 用户下注额 × 100%

// 5. 平台手续费
平台手续费 = Σ(所有选项下注额) × 0.03
```

### 波动计算
```javascript
// 基准价格（多源中位数）
基准价格 = median([Binance, Coinbase, Kraken])

// 结算价格（多源中位数）
结算价格 = median([Binance, Coinbase, Kraken])

// 波动幅度
波动幅度 = |结算价格 - 基准价格| / 基准价格 × 100%
```

---

## 🎮 玩法规则对比

| 玩法 | 预测难度 | 中奖概率 | 潜在收益 | 风险等级 |
|------|---------|---------|---------|---------|
| **数据狙击手** | ⭐⭐⭐ | 33% (1/3) | 1.5-5x | 中 |
| **波动猎人** | ⭐⭐ | 50% (1/2) | 1.2-3x | 低 |
| **精准点位** | ⭐⭐⭐⭐⭐ | 14% (1/7) | 5-100x | 高 |

**特点总结**：
- 数据狙击手：需宏观经济知识，适合专业用户
- 波动猎人：不赌方向只赌波动，适合保守用户
- 精准点位：高风险高回报，适合激进用户

---

## 🔐 风控参数总览

```javascript
// 下注限制
MIN_BET = 10 USDT
MAX_BET_PER_ORDER = 10,000 USDT
MAX_BET_PER_USER_PER_EVENT = 50,000 USDT
MAX_POOL_SIZE_PER_GAME = 1,000,000 USDT

// 时间控制
BET_OPEN_BEFORE_EVENT = 7 days
BET_CLOSE_BEFORE_EVENT = 5 minutes
PRICE_SAMPLING_DELAY = 15 minutes

// 手续费
PLATFORM_FEE_RATE = 3%
GAS_FEE = ~0.5 USDT (用户承担)

// 赔率控制
MAX_ODDS = 100x

// 数据验证
MIN_ORACLE_CONFIRMATIONS = 3/5
PRICE_CONSISTENCY_THRESHOLD = 0.5%
TIMESTAMP_TOLERANCE = ±2 minutes

// 结算保证
NORMAL_SETTLEMENT_TIME = 15-20 minutes
MAX_SETTLEMENT_TIME = 24 hours

// 争议处理
DISPUTE_PERIOD = 24 hours
DISPUTE_RESOLUTION_TIME = 3 working days
EMERGENCY_RESETTLE_PERIOD = 7 days
```

---

## 📈 用户体验优化

### 下注确认弹窗
包含完整信息：
- ✅ 事件和玩法信息
- ✅ 预测选项
- ✅ 下注金额
- ✅ 当前赔率（标注实时变动）
- ✅ 预估总回报
- ✅ 预估净收益
- ✅ 费用明细（手续费 + Gas 费）
- ✅ 重要提示（不可撤销等）

### 结算通知
三种类型：
1. **获胜通知** - 显示公布结果、收益金额、收益率
2. **失败通知** - 显示正确答案、亏损金额、下次机会
3. **退款通知** - 说明退款原因、退款金额、无手续费

---

## 🚀 后续迭代计划

### V1.1 优化
- [ ] 动态波动阈值（根据事件重要性调整）
- [ ] 精准点位智能区间（基于历史波动率）
- [ ] 对冲策略推荐
- [ ] 更多宏观事件（失业率、零售销售、PMI 等）
- [ ] 赔率趋势图

### V1.2 功能增强
- [ ] Layer 2 迁移（降低 Gas 费 95%）
- [ ] 社交跟单功能
- [ ] VIP 会员体系（手续费折扣）
- [ ] 保险对冲产品
- [ ] 移动端原生应用

### V2.0 生态建设
- [ ] DAO 治理
- [ ] 流动性挖矿
- [ ] NFT 成就系统
- [ ] 排行榜和竞赛
- [ ] 策略分享市场

---

## 📝 文档使用指南

### 开发团队
- 前端开发：参考 PRD_详细版.md 的 UI/UX 设计规范和功能需求
- 后端开发：参考下注与结算规则详细说明.md 的业务逻辑
- 智能合约：参考结算规则和资金安全部分

### 产品团队
- 产品经理：两份文档配合使用，理解完整产品逻辑
- UI/UX 设计师：参考 PRD_详细版.md 的设计规范和组件库

### 测试团队
- 功能测试：参考下注与结算规则详细说明.md 的各种场景
- 边界测试：参考风控参数和特殊情况处理
- 压力测试：参考风控参数中的限制值

### 运营团队
- 用户教育：参考 FAQ 和玩法规则对比
- 客服支持：参考特殊情况处理和争议机制
- 市场推广：参考核心价值和玩法特点

---

## ✅ 完善内容检查清单

- [x] 奖金池机制完整说明
- [x] 手续费 3% 详细规则
- [x] 无人中奖退款机制
- [x] 下注金额限制
- [x] 下注时间窗口
- [x] 下注不可撤销规则
- [x] 多次下注和对冲策略
- [x] 结算触发条件
- [x] 三种玩法的结算计算
- [x] 结算时间保证（SLA）
- [x] 特殊情况处理流程
- [x] Oracle 故障备用方案
- [x] 结算争议机制
- [x] 资金安全机制
- [x] 保险基金设计
- [x] 风控参数表
- [x] 核心公式汇总
- [x] 用户界面示例
- [x] FAQ 常见问题

---

## 🎯 关键决策总结

1. **手续费率**：3%（行业标准，保证平台可持续运营）
2. **下注不可撤销**：保证奖金池公平性
3. **无人中奖退款**：仅精准点位，100% 退款
4. **结算延迟**：15 分钟（价格稳定期，防止操纵）
5. **最高赔率**：100x（风险控制）
6. **多数据源验证**：3/5 Oracle 确认（去中心化）
7. **自动提取奖金**：默认开启（用户体验优先）

---

**文档版本**：V1.0
**最后更新**：2026-01-17
**完善人员**：产品团队
**审核状态**：待审核

---

## 📞 联系方式

如有疑问或建议，请联系：
- 产品团队：product@macroshockwave.com
- 技术团队：dev@macroshockwave.com
- 客服支持：support@macroshockwave.com
